{{template "_header.html" .}}
<title>Settings | polycloze</title>
{{template "_nav.html" .}}

<main>
	<h1>Settings</h1>

	<h2>{{.course.L2.Name}} from {{.course.L1.Name}} settings</h2>

	<course-settings></course-settings>

	<h2>Import data</h2>

	<form
		class="signin"
		action="/api/settings/upload/{{.course.L1.Code}}/{{.course.L2.Code}}"
		method="POST"
		enctype="multipart/form-data"
		>
		{{template "_csrf.html" .}}
		<input id="csv-upload" name="csv-upload" type="file" accept=".csv" required>

		<p class="button-group">
			<button type="submit">Upload CSV file</button>
		</p>

		<script>
			// Checks if the file is too big (>8MB).
			function isTooBig(file) {
				return file.size > 8 * 1024 * 1024;
			}

			const csvUpload = document.getElementById("csv-upload");
			csvUpload.addEventListener("change", () => {
				for (const file of csvUpload.files) {
					if (isTooBig(file)) {
						csvUpload.setCustomValidity("The file is too big.");
						csvUpload.reportValidity()
					} else {
						csvUpload.setCustomValidity("");
					}
				}
			});
		</script>
	</form>

	<h2>Export data</h2>

	<div>
		<p style="justify-content:center" class="button-group">
			<a class="button" href="/personal/reviews/{{.course.L1.Code}}-{{.course.L2.Code}}.db">
				<img src="/svg/ph@1.4.0/download.svg" alt=""> Export data (SQLite)
			</a>
		</p>
	</div>

	<h2>Change password</h2>

	<form class="signin" action="/settings" method="POST">
		{{template "_csrf.html" .}}
		<div>
			<label for="username" style="display:block">Username</label>
			<input id="username" name="username" required autocapitalize="none" value="{{.username}}" disabled>
		</div>

		<div>
			<label for="current-password" style="display:block">Current password</label>
			<input id="current-password" name="current-password" type="password" required>
		</div>

		<div>
			<label for="new-password" style="display:block">New password</label>
			<input id="new-password" name="new-password" type="password" required>
		</div>

		<div>
			<label for="confirm-password" style="display:block">Confirm password</label>
			<input id="confirm-password" name="confirm-password" type="password" required>
		</div>

		{{if .message}}
		<div class="incorrect">{{.message}}</div>
		{{end}}

		<p class="button-group">
			<button type="submit">
				<img src="/svg/ph@1.4.0/key.svg" alt=""> Change password
			</button>
		</p>

		<script>
			const newPassword = document.getElementById("new-password");
			const confirmPassword = document.getElementById("confirm-password")
			const button = document.querySelector('form.signin button[type="submit"]')
			button.addEventListener("click", event => {
				if (newPassword.value === confirmPassword.value) {
					newPassword.setCustomValidity("")
					confirmPassword.setCustomValidity("")
				} else {
					const message = "Passwords don't match."
					newPassword.setCustomValidity(message)
					confirmPassword.setCustomValidity(message)
					newPassword.reportValidity()
					confirmPassword.reportValidity()
					event.preventDefault()
					event.stopPropagation()
				}
			})
		</script>
	</form>
</main>

{{template "_footer.html"}}
